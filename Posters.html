<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Posters</title>
<style>
  body { font-family: Arial, sans-serif; background:#f0f2f5; margin:0; }
  #app { max-width:600px; margin:20px auto; background:white; padding:20px; border-radius:10px; }
  .post, .comment { border:1px solid #ccc; border-radius:5px; padding:10px; margin:10px 0; background:#fafafa; }
  img { max-width:100%; border-radius:5px; }
  input, textarea { width:100%; margin:5px 0; padding:8px; }
  button { padding:8px 12px; margin-top:5px; cursor:pointer; }
  .commentBox { margin-left:20px; }
</style>
</head>
<body>
<div id="app"></div>

<script>
// ----- CONFIG -----
const GITHUB_USERNAME = "kareemiismail";
const GITHUB_REPO = "Posters";
const GITHUB_TOKEN = "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";
const POSTS_PATH = "posts"; // folder in repo where JSON files will be stored

// ----- UTILS -----
function apiHeaders() {
  return {
    "Authorization": "token " + GITHUB_TOKEN,
    "Accept": "application/vnd.github+json"
  };
}

async function fetchPosts() {
  const res = await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${POSTS_PATH}`, { headers: apiHeaders() });
  if (!res.ok) return [];
  const files = await res.json();
  let posts = [];
  for (let file of files) {
    const fileRes = await fetch(file.download_url);
    const data = await fileRes.json();
    posts.push(data);
  }
  posts.sort((a,b)=>b.timestamp - a.timestamp);
  return posts;
}

async function savePostToGitHub(post) {
  const filename = `${POSTS_PATH}/${Date.now()}-${post.user}.json`;
  const content = btoa(JSON.stringify(post)); // base64 encode
  await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filename}`, {
    method: "PUT",
    headers: apiHeaders(),
    body: JSON.stringify({ message: "New post", content })
  });
}

// ----- LOCAL LOGIN -----
let users = JSON.parse(localStorage.getItem("users") || "[]");
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");

function saveLocal() {
  localStorage.setItem("users", JSON.stringify(users));
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
}

// ----- RENDER -----
async function render() {
  const app = document.getElementById("app");
  if (!currentUser) {
    app.innerHTML = `
      <h2>Login / Register</h2>
      <input id="username" placeholder="Username">
      <input id="password" placeholder="Password" type="password">
      <button onclick="login()">Login</button>
      <button onclick="register()">Register</button>
    `;
    return;
  }

  let posts = await fetchPosts();

  let html = `
    <h2>Welcome, ${currentUser}</h2>
    <button onclick="logout()">Logout</button>
    <h3>Create Post</h3>
    <textarea id="postText" placeholder="What's on your mind?"></textarea>
    <input type="file" id="postImage" accept="image/*">
    <button onclick="createPost()">Post</button>
    <h3>Feed</h3>
  `;

  posts.forEach((p,i)=>{
    html += `
      <div class="post">
        <b>${p.user}</b><br>
        ${p.text?`<p>${p.text}</p>`:""}
        ${p.image?`<img src="${p.image}">`:''}
        <div class="comments">
          <h4>Comments</h4>
          ${p.comments.map(c=>`<div class="comment"><b>${c.user}</b>: ${c.text}</div>`).join("")}
          <div class="commentBox">
            <input id="comment-${i}" placeholder="Write a comment...">
            <button onclick="addComment(${i})">Comment</button>
          </div>
        </div>
      </div>
    `;
  });

  app.innerHTML = html;
}

// ----- LOGIN / REGISTER -----
function register() {
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  if(!u||!p) return alert("Fill all fields");
  if(users.find(x=>x.user===u)) return alert("User exists");
  users.push({user:u,pass:p});
  currentUser = u;
  saveLocal();
  render();
}

function login() {
  const u = document.getElementById("username").value.trim();
  const p = document.getElementById("password").value;
  if(!users.find(x=>x.user===u && x.pass===p)) return alert("Invalid login");
  currentUser = u;
  saveLocal();
  render();
}

function logout() {
  currentUser=null;
  saveLocal();
  render();
}

// ----- CREATE POST -----
async function createPost() {
  const text = document.getElementById("postText").value.trim();
  const fileInput = document.getElementById("postImage");
  const file = fileInput.files[0];

  if(!text && !file) return alert("Nothing to post!");

  let imageData = null;
  if(file){
    imageData = await new Promise(resolve=>{
      const reader = new FileReader();
      reader.onload = e=>resolve(e.target.result);
      reader.readAsDataURL(file);
    });
  }

  const post = { user: currentUser, text, image: imageData, comments: [], timestamp: Date.now() };
  await savePostToGitHub(post);
  document.getElementById("postText").value="";
  document.getElementById("postImage").value="";
  render();
}

// ----- ADD COMMENT -----
async function addComment(index){
  const input = document.getElementById("comment-"+index);
  const text = input.value.trim();
  if(!text) return;

  let posts = await fetchPosts();
  let post = posts[index];
  post.comments.push({ user: currentUser, text });

  // Save updated post back to GitHub
  const filename = `${POSTS_PATH}/${post.timestamp}-${post.user}.json`;
  const content = btoa(JSON.stringify(post));
  await fetch(`https://api.github.com/repos/${GITHUB_USERNAME}/${GITHUB_REPO}/contents/${filename}`, {
    method:"PUT",
    headers:apiHeaders(),
    body:JSON.stringify({ message:"Update post", content })
  });
  input.value="";
  render();
}

// ----- INIT -----
render();
setInterval(render, 5000); // refresh feed every 5 seconds
</script>
</body>
</html>
